<div class="wrapper">
    <h1><i class="fa fa-twitter"></i> Happening Right Now</h1>

    <div id="stream-controls">
        <div class="left btn-group" role="group">
            <button type="button" id="list-view" class="btn btn-default"><i class="fa fa-th-list"></i> <span>List View</span></button>
            <button type="button" id="map-view" class="btn btn-default"><i class="fa fa-map-marker"></i> <span>Map View</span></button>
        </div>

        <div class="right">
            <button type="button" id="pause" class="btn btn-default"><span>Pause</span> &nbsp;<i class="fa fa-pause"></i>&nbsp;</a>
        </div>
    </div>

    <ul id="tweets" class="list-group">
        <li class="list-group-item tweet-template">
            <a class="profile-picture" target="_blank" href=""><img src="" /></a>

            <div class="tweet-details">
                <div class="clear">
                    <h2 class="handle left"><a target="_blank" href=""></a> <span></span></h2>
                    <p class="timestamp right"><i class="fa fa-clock-o"></i> <span title=""></span></time>
                </div>

                <p class="text"></p>

                <ul class="tweet-actions">
                    <li class="reply"><a href=""><i class="fa fa-reply"></i></a></li>
                    <li class="favorite"><a href=""><i class="fa fa-star"></i></a></li>
                    <li class="retweet"><a href=""><i class="fa fa-retweet"></i></a></li>
                </ul>
            </div>
        </li>
    </ul>
</div>

<script type="text/javascript">
    /**
     * Whether the stream is paused or not
     * 
     * @type {Boolean}
     */
    paused = false;

    /**
     * Generate tweet HTML markup
     * 
     * @param  {json} tweet JSON array containing tweet information
     * @return {Jquery} DOM object with tweet information
     */
    function htmlify(tweet) {
        tweetHtml = $('.tweet-template').clone();
        tweetHtml.find('.text').append($.parseHTML(tweet.text_html));
        tweetHtml.find('.handle a').text(tweet.user.name).attr('href', 'https://twitter.com/' + tweet.user.screen_name);
        tweetHtml.find('.handle span').text('@' + tweet.user.screen_name);
        tweetHtml.find('.profile-picture img').attr('src', tweet.user.profile_image_url_https.replace('_normal', ''));

        var time = new Date(parseInt(tweet.timestamp_ms)).toISOString();
        tweetHtml.find('.timestamp span').attr('title', time);

        return tweetHtml;
    }

    /**
     * Insert tweet into page
     * 
     * @param  {JQuery} tweet DOM object with tweet information
     * @return none
     */
    function insert(tweet) {

        tweetHtml.prependTo('#tweets').fadeIn(2000).removeClass('tweet-template');
        init(tweetHtml);
    }

    /**
     * Initialize a tweet
     * 
     * @param  {JQuery} tweet DOM object with tweet information
     * @return none
     */
    function init(tweet) {
        tweet.find('.timestamp span').timeago();
    }

    /**
     * Destroy a tweet
     * 
     * @param  {JQuery} tweet DOM object with tweet information
     * @return none
     */
    function destroy(tweet) {
        tweet.find('.timestamp').timeago('dispose');
    }

    /**
     * Process an incoming tweet from the web socket
     * 
     * @return none
     */
    function processTweet(tweet) {
        if (!paused) {
            tweet = $.parseJSON(tweet);
            console.log(tweet);

            if (tweet.geo) {
                tweet = htmlify(tweet);
                insert(tweet);
                tweet = null;
            }
        }
    }

    /**
     * Start/stop tweet stream
     * 
     * @return none
     */
    function toggleStream() {
        if(paused) {
            paused = false;
        } else {
            paused = true;
        }
    }

    // Initialize web socket
    var dispatcher = new WebSocketRails('wss://ws.ubvoting.com/websocket');
    var channel = dispatcher.subscribe('tweets');
    channel.bind('new_tweet', function(data) {
        processTweet(data);
    });

    // DOM ready
    $(document).ready(function() {
        // Stream control buttons (pause, play)
        $('#pause').on('click', function() {
            // Enable/disable stream
            toggleStream();

            // Update button text and icon
            var text = $(this).find('span').text();
            $(this).find('span').text(text == 'Pause' ? 'Play' : 'Pause');
            $(this).find('i').toggleClass('fa-pause fa-play');
            $(this).blur();
        });
    });
</script>